<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>fabric学习 | 魔法☆梅莉</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/meili.jpg">
    <meta name="description" content="L15hee7的个人blog">
    <link rel="preload" href="/assets/css/0.styles.b33b8572.css" as="style"><link rel="preload" href="/assets/js/app.b6aa09f0.js" as="script"><link rel="preload" href="/assets/js/2.be74dbea.js" as="script"><link rel="preload" href="/assets/js/19.96f8f9b6.js" as="script"><link rel="prefetch" href="/assets/js/10.3ff3ecee.js"><link rel="prefetch" href="/assets/js/11.a221821f.js"><link rel="prefetch" href="/assets/js/12.06998f09.js"><link rel="prefetch" href="/assets/js/13.ffd3dadc.js"><link rel="prefetch" href="/assets/js/14.fc64ac2e.js"><link rel="prefetch" href="/assets/js/15.dd285966.js"><link rel="prefetch" href="/assets/js/16.7ed8b83a.js"><link rel="prefetch" href="/assets/js/17.8fb916a8.js"><link rel="prefetch" href="/assets/js/18.eeb0d10b.js"><link rel="prefetch" href="/assets/js/20.c700f3ed.js"><link rel="prefetch" href="/assets/js/21.2e5b68bf.js"><link rel="prefetch" href="/assets/js/3.00b422a5.js"><link rel="prefetch" href="/assets/js/4.92e35ee9.js"><link rel="prefetch" href="/assets/js/5.d4aa99cd.js"><link rel="prefetch" href="/assets/js/6.12fc1b54.js"><link rel="prefetch" href="/assets/js/7.ca9bfdc4.js"><link rel="prefetch" href="/assets/js/8.07b499f2.js"><link rel="prefetch" href="/assets/js/9.ee404436.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b33b8572.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="nav-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-6 ant-col-xl-5 ant-col-xxl-4"><a href="/" class="router-link-active home-link"><img src="/img/meili.jpg" alt="魔法☆梅莉" class="logo"> <span class="site-name">魔法☆梅莉</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="nav-space-between ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-18 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          论文学习
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-submenu-selected"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          学习相关
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          日常
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          pc使用相关
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          动态
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <ul class="extra-group"><!----> <!----></ul></nav></div></div> <!----></header> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/study/" aria-current="page" title="更新日期" class="sidebar-link">更新日期</a></li><li><a href="/study/git密钥问题.html" title="解决git@github.com: Permission denied (publickey)问题" class="sidebar-link">解决git@github.com: Permission denied (publickey)问题</a></li><li><a href="/study/搭建fabric环境.html" title="搭建Fabric环境" class="sidebar-link">搭建Fabric环境</a></li><li><a href="/study/yaml学习.html" title="yaml文件编写" class="sidebar-link">yaml文件编写</a></li><li><a href="/study/fabric学习.html" title="fabric学习" class="active sidebar-link">fabric学习</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/fabric学习.html#_0x00-to-begin-with" title="0x00 To begin with" class="sidebar-link">0x00 To begin with</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#_0x01-区块链基础知识" title="0x01 区块链基础知识" class="sidebar-link">0x01 区块链基础知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/fabric学习.html#区块block" title="区块block" class="sidebar-link">区块block</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#区块链blockchain" title="区块链blockchain" class="sidebar-link">区块链blockchain</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#类型" title="类型" class="sidebar-link">类型</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#智能合约smart-contract" title="智能合约Smart contract" class="sidebar-link">智能合约Smart contract</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#hyperledger-fabric相关知识" title="Hyperledger Fabric相关知识" class="sidebar-link">Hyperledger Fabric相关知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/fabric学习.html#整体介绍" title="整体介绍" class="sidebar-link">整体介绍</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#联盟" title="联盟" class="sidebar-link">联盟</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#节点" title="节点" class="sidebar-link">节点</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#通道" title="通道" class="sidebar-link">通道</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#链码" title="链码" class="sidebar-link">链码</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#搭建区块链网络" title="搭建区块链网络" class="sidebar-link">搭建区块链网络</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#编写智能合约" title="编写智能合约" class="sidebar-link">编写智能合约</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#部署链码" title="部署链码" class="sidebar-link">部署链码</a></li><li class="sidebar-sub-header"><a href="/study/fabric学习.html#编写应用程序" title="编写应用程序" class="sidebar-link">编写应用程序</a></li></ul></li></ul></li><li><a href="/study/remix使用.html" title="Remix使用以及部分合约漏洞复现" class="sidebar-link">Remix使用以及部分合约漏洞复现</a></li><li><a href="/study/机器学习.html" title="机器学习相关" class="sidebar-link">机器学习相关</a></li><li><a href="/study/LaTex学习.html" title="LaTex学习和使用" class="sidebar-link">LaTex学习和使用</a></li><li><a href="/study/Jupyter Notebook的安装和使用.html" title="Jupyter Notebook的安装和使用" class="sidebar-link">Jupyter Notebook的安装和使用</a></li></ul> </aside> <main class="page has-page-anchor"> <div class="theme-antdocs-content content__default"><h1 id="fabric学习"><a href="#fabric学习" class="header-anchor">#</a> fabric学习</h1> <h2 id="_0x00-to-begin-with"><a href="#_0x00-to-begin-with" class="header-anchor">#</a> 0x00 To begin with</h2> <p>在前几天跑通了一个基于fabric的实例，总结一下在整个过程中学习到的知识。</p> <h2 id="_0x01-区块链基础知识"><a href="#_0x01-区块链基础知识" class="header-anchor">#</a> 0x01 区块链基础知识</h2> <h3 id="区块block"><a href="#区块block" class="header-anchor">#</a> 区块block</h3> <p><code>Block</code> ，每个区块记录着上一个区块的 <code>hash</code> 值、本区块中的交易集合、本区块的 <code>hash</code> 等基础数据。由于每个区块都有上一区块的 <code>hash</code> 值，区块间由这个值两两串联，形成了区块链。</p> <h3 id="区块链blockchain"><a href="#区块链blockchain" class="header-anchor">#</a> 区块链blockchain</h3> <p>区块链本质上就是一个多方共享的<strong>分布式账本</strong>技术，用来记录网络上发生的所有交易。</p> <p>而其中<strong>去中心化</strong>的概念，是因为账本信息会被复制到许多网络参与者中，每个参与者都在<strong>协作</strong>维护账本，不像传统应用的数据被中心管理着。</p> <p>另外信息只能以附加的方式记录到账本上，并使用加密技术保证一旦将交易添加到账本就无法修改。这种<strong>不可修改</strong>的属性简化了信息的溯源，因为参与者可以确定信息在记录后没有改变过。所以区块链有时也被称为<strong>证明系统</strong>。</p> <h3 id="类型"><a href="#类型" class="header-anchor">#</a> 类型</h3> <ul><li>完全去中心化：公链，人人都可以参与，就像比特币（挖矿相当于在记账）。主要采取工作量证明机制(POW)、权益证明机制(POS)、股份授权证明机制(DPOS)等方式。</li> <li>部分去中心化：联盟链，参与者是指定的。联盟链可以是几家公司共同拥有的链，也可能是几个国家共同承认的链。这是后续发展的趋势。</li> <li>中心化：私链，写入权限仅在一个组织手里的区块链，仅对特定的团队、组织或者个人开放。</li></ul> <h3 id="智能合约smart-contract"><a href="#智能合约smart-contract" class="header-anchor">#</a> 智能合约Smart contract</h3> <p><code>Smart contract</code>，为了支持以同样的方式更新信息，并实现一整套账本功能（交易，查询等），区块链使用智能合约来提供对账本的受控访问。</p> <p>智能合约不仅是在网络中封装和简化信息的关键机制，它还可以被编写成自动执行参与者的特定交易的合约。</p> <p>例如，可以编写智能合约以规定运输物品的成本，其中运费根据物品到达的速度而变化。根据双方同意并写入账本的条款，当收到物品时，相应的资金会自动转手。</p> <p>通俗易懂点，智能合约就是按照大家约定好的规则编写的业务逻辑代码实现，然后只能通过这些合约来操作区块链网络这个账本</p> <h2 id="hyperledger-fabric相关知识"><a href="#hyperledger-fabric相关知识" class="header-anchor">#</a> Hyperledger Fabric相关知识</h2> <h3 id="整体介绍"><a href="#整体介绍" class="header-anchor">#</a> 整体介绍</h3> <p>Hyperledger Fabric 网络的成员只能从可信赖的成员服务提供者（MSP） 注册，因此fabric搭建的链是联盟链。</p> <p>Hyperledger Fabric 的账本包括两个组件： 世界状态和交易日志。并且每个参与者都拥有他们所属的每个 Hyperledger Fabric 网络的账本的副本。</p> <ul><li>世界状态：描述了在给定时间点的账本的状态。它是账本的数据库。默认情况下，使用 LevelDB 键值存储数据库，可插拔，可替换为 CouchDB 。</li> <li>交易日志：记录产生世界状态中当前值的所有交易。这是世界状态的更新历史。它只记录区块链网络使用账本数据库前后的值。</li></ul> <p>总结：Hyperledger Fabric 是一种账本技术，其账本包括世界状态数据库和交易日志历史记录。</p> <h3 id="联盟"><a href="#联盟" class="header-anchor">#</a> 联盟</h3> <p>联盟指参与一个基于区块链的业务协作或业务交易网络的所有组织的集合，一个联盟一般包含多个组织。</p> <p>一般由联盟发起方或运营方创建 <code>Orderer</code> 排序节点，并负责交易排序、区块产生和达成共识。联盟发起方或运营方邀请各个组织实例加入联盟，进而创建通道。</p> <p>组织代表的是参与区块链网络的企业、政府机构、团体等实体。</p> <p>一个组织实例主要包含如下节点：</p> <ul><li><code>CA</code> ：区块链节点类型之一，全称 Certificate Authority ，数字证书颁发机构，负责组织内部成员的 <code>register</code> 和 <code>enroll</code> 等，为该组织的区块链用户生成和颁发数字证书。</li> <li><code>Peer</code> ：区块链节点类型之一，负责保存和记录账本数据、对交易背书、运行智能合约等。</li></ul> <h3 id="节点"><a href="#节点" class="header-anchor">#</a> 节点</h3> <p>节点（Peers）是区块链的通信实体。它只是一个逻辑功能，只要能在“信任域”中分组并与控制它们的逻辑实体相关联，就可以将不同类型的多个节点运行在同一个物理服务器上，比如用 Docker 部署。</p> <ul><li><code>Orderer</code> 排序服务节点 或 排序节点：Orderer 是一个运行实现交付担保的通信服务节点，例如原子性或总顺序广播。排序节点负责接受交易并排序（排序算法有: SOLO，KAFKA，RAFT，PBFT），最后将排序好的交易按照配置中的约定整理为区块之后提交给记账节点进行处理。</li> <li><code>Peer</code> 节点：Peer 是业务参与方组织在区块链网络中所拥有的参与共识和账本记录的节点。可以有多种角色。作为 <code>Committing Peer</code> 记账节点时，无需安装链码，只负责验证从 Orderer 发出的区块和交易的合法性、并存储账本区块信息。作为 <code>Endorsing Peer</code> 背书节点时，必须安装链码，在交易时需进行签名背书。</li> <li><code>Anchor</code> 锚节点：为了实现高可用，每个参与方组织一般包含两个或多个 <code>Peer</code> 节点，可以设置其中的一个为 <code>Anchor</code> ，与区块链网络中的其他组织进行信息同步。</li> <li>客户端节点：客户端扮演了代表最终用户的实体，可以同时与 <code>Peer</code> 和 <code>Orderer</code> 通信，创建并调用交易。这里客户端可以指应用程序、SDK、命令行等。</li></ul> <h3 id="通道"><a href="#通道" class="header-anchor">#</a> 通道</h3> <p>Hyperledger Fabric 中的通道（<code>Channel</code>）是两个或两个以上特定网络成员之间通信的专用“子网”，用于进行私有和机密的交易。</p> <p>可以理解为组织间拉了个群聊，这个群聊就是通道，在里面聊天交易，一个联盟链中可以有多个群聊（通道），一个组织可以加入多个群聊，每个群聊可以代表一项具体的业务，有自身对应的一套账本，群聊间互不干扰，互相隔离。</p> <h3 id="链码"><a href="#链码" class="header-anchor">#</a> 链码</h3> <p>Hyperledger Fabric 的智能合约用链码（<code>Chaincode</code>）编写。在大多数情况下，链码只与账本的数据库即世界状态交互，而不与交易日志交互。</p> <p>链码可以用多种编程语言实现。有 Go、Node.js 和 Java 链码等。</p> <h3 id="搭建区块链网络"><a href="#搭建区块链网络" class="header-anchor">#</a> 搭建区块链网络</h3> <p>1、下载 fabric 二进制工具</p> <p>以 <code>v1.4.12</code> 版本为例， fabric 二进制工具的下载地址在：<strong>https://github.com/hyperledger/fabric/releases/tag/v1.4.12</strong>[3]</p> <p>自行根据你的系统环境下载对应的包。</p> <p>其中几个主要的工具说明：</p> <ul><li><code>cryptogen</code> ：用来生成 Hyperledger Fabric 密钥材料的工具，这个过程是静态的。<code>cryptogen</code> 工具通过一个包含网络拓扑的 <code>crypto-config.yaml</code> 文件，为所有组织和属于这些组织的组件生成一组证书和秘钥。<code>cryptogen</code> 适合用于测试开发环境，在生产环境建议使用动态的 CA 服务。</li> <li><code>configtxgen</code> ：用于创建和查看排序节点的创世区块、通道配置交易等相关的工具。<code>configtxgen</code> 使用 <code>configtx.yaml</code> 文件来定义网络配置。</li> <li><code>configtxlator</code>：fabric 中 <code>Protobuf</code> 和 <code>JSON</code> 格式转换的工具，fabric 中任何的使用 <code>Protobuf</code> 定义的类型，都可使用该工具进行转换。</li> <li><code>peer</code>：peer 命令有 5 个不同的子命令，每个命令都可以让指定的 peer 节点执行特定的一组任务。比如，可以使用子命令 <code>peer channel</code> 让一个 peer 节点加入通道，或者使用 <code>peer chaincode</code> 命令把智能合约链码部署到 peer 节点上。</li></ul> <p>2、将 fabric 二进制工具添加到环境变量</p> <p>为了后续方便使用命令，可以将第 1 步下载的工具添加到系统环境变量中：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ export PATH=${PWD}/hyperledger-fabric-linux-amd64-1.4.12/bin:$PATH
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3、生成证书和秘钥</p> <p>我们将使用 <code>cryptogen</code> 工具生成各种加密材料（ x509 证书和签名秘钥）。这些证书是身份的代表，在实体相互通信和交易的时候，可以对其身份进行签名和验证。</p> <p>首先创建 <code>crypto-config.yaml</code> 文件，定义网络拓扑，为所有组织和属于这些组织的组件（也就是节点）生成一组证书和秘钥，内容如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 排序节点的组织定义
OrdererOrgs:
  - Name: QQ # 名称
    Domain: qq.com # 域名
    Specs: # 节点域名：orderer.qq.com
      - Hostname: orderer # 主机名

# peer节点的组织定义
PeerOrgs:
  # Taobao-组织
  - Name: Taobao # 名称
    Domain: taobao.com # 域名
    Template: # 使用模板定义。Count 指的是该组织下组织节点的个数
      Count: 2 # 节点域名：peer0.taobao.com 和 peer1.taobao.com
    Users: # 组织的用户信息。Count 指该组织中除了 Admin 之外的用户的个数
      Count: 1 # 用户：Admin 和 User1

  # JD-组织
  - Name: JD
    Domain: jd.com
    Template:
      Count: 2 # 节点域名：peer0.jd.com 和 peer1.jd.com
    Users:
      Count: 1 # 用户：Admin 和 User1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>接着执行 <code>cryptogen generate</code> 命令，生成结果将默认保存在 <code>crypto-config</code> 文件夹中：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ cryptogen generate --config=./crypto-config.yaml
taobao.com
jd.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们可以看看在 <code>crypto-config</code> 文件夹里生成了什么：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ tree crypto-config
crypto-config
├── ordererOrganizations
│   └── qq.com
│       ├── ca
│       │   ├── 3e41f960bb5a3002a1e436e9079311d79cf8846c2ad2a09080ea8575e16bb5b7_sk
│       │   └── ca.qq.com-cert.pem
│       ├── msp
│       │   ├── admincerts
│       │   │   └── Admin@qq.com-cert.pem
│       │   ├── cacerts
│       │   │   └── ca.qq.com-cert.pem
│       │   └── tlscacerts
│       │       └── tlsca.qq.com-cert.pem
│       ├── orderers
│       │   └── orderer.qq.com
│       │       ├── msp
│       │       │   ├── admincerts
│       │       │   │   └── Admin@qq.com-cert.pem
│       │       │   ├── cacerts
│       │       │   │   └── ca.qq.com-cert.pem
│       │       │   ├── keystore
│       │       │   │   └── 6bd45f78877b96cfbcd040262ee4c808bd6d894cabfed44552fb7c22d6d427d1_sk
│       │       │   ├── signcerts
│       │       │   │   └── orderer.qq.com-cert.pem
│       │       │   └── tlscacerts
│       │       │       └── tlsca.qq.com-cert.pem
│       │       └── tls
│       │           ├── ca.crt
│       │           ├── server.crt
│       │           └── server.key
│       ├── tlsca
│       │   ├── bd48b5360c82ce5beeb31dea1b7e8e7918a5e7246d3f8892889fe1b2efadc1aa_sk
│       │   └── tlsca.qq.com-cert.pem
│       └── users
│           └── Admin@qq.com
│               ├── msp
│               │   ├── admincerts
│               │   │   └── Admin@qq.com-cert.pem
│               │   ├── cacerts
│               │   │   └── ca.qq.com-cert.pem
│               │   ├── keystore
│               │   │   └── f28c1ed4c67fd438a891e420a2e53b20352bdf40907a0a8ee39095505475c99f_sk
│               │   ├── signcerts
│               │   │   └── Admin@qq.com-cert.pem
│               │   └── tlscacerts
│               │       └── tlsca.qq.com-cert.pem
│               └── tls
│                   ├── ca.crt
│                   ├── client.crt
│                   └── client.key
└── peerOrganizations
    ├── jd.com
    │   ├── ca
    │   │   ├── 5672a9717fd943d0dcd2269ea1700c10309ad49d16b849e9c6e24225deafceb5_sk
    │   │   └── ca.jd.com-cert.pem
    │   ├── msp
    │   │   ├── admincerts
    │   │   │   └── Admin@jd.com-cert.pem
    │   │   ├── cacerts
    │   │   │   └── ca.jd.com-cert.pem
    │   │   └── tlscacerts
    │   │       └── tlsca.jd.com-cert.pem
    │   ├── peers
    │   │   ├── peer0.jd.com
    │   │   │   ├── msp
    │   │   │   │   ├── admincerts
    │   │   │   │   │   └── Admin@jd.com-cert.pem
    │   │   │   │   ├── cacerts
    │   │   │   │   │   └── ca.jd.com-cert.pem
    │   │   │   │   ├── keystore
    │   │   │   │   │   └── 012700eb44d6e19becb63c944e685a18d69ea9f1120aaa45fe549236c6a90fb6_sk
    │   │   │   │   ├── signcerts
    │   │   │   │   │   └── peer0.jd.com-cert.pem
    │   │   │   │   └── tlscacerts
    │   │   │   │       └── tlsca.jd.com-cert.pem
    │   │   │   └── tls
    │   │   │       ├── ca.crt
    │   │   │       ├── server.crt
    │   │   │       └── server.key
    │   │   └── peer1.jd.com
    │   │       ├── msp
    │   │       │   ├── admincerts
    │   │       │   │   └── Admin@jd.com-cert.pem
    │   │       │   ├── cacerts
    │   │       │   │   └── ca.jd.com-cert.pem
    │   │       │   ├── keystore
    │   │       │   │   └── b1e81b66080705595f5e56cc8d78575b0e935b79c8f674001e46cae452a71f32_sk
    │   │       │   ├── signcerts
    │   │       │   │   └── peer1.jd.com-cert.pem
    │   │       │   └── tlscacerts
    │   │       │       └── tlsca.jd.com-cert.pem
    │   │       └── tls
    │   │           ├── ca.crt
    │   │           ├── server.crt
    │   │           └── server.key
    │   ├── tlsca
    │   │   ├── f4c7d0b660575f383d189696480bf559f312d798eb0352c9102f8be6ecde52d6_sk
    │   │   └── tlsca.jd.com-cert.pem
    │   └── users
    │       ├── Admin@jd.com
    │       │   ├── msp
    │       │   │   ├── admincerts
    │       │   │   │   └── Admin@jd.com-cert.pem
    │       │   │   ├── cacerts
    │       │   │   │   └── ca.jd.com-cert.pem
    │       │   │   ├── keystore
    │       │   │   │   └── d7f476884ff36a19aa7100c63aa30f8f378cc5ec826ca58977539e1c9c6b22df_sk
    │       │   │   ├── signcerts
    │       │   │   │   └── Admin@jd.com-cert.pem
    │       │   │   └── tlscacerts
    │       │   │       └── tlsca.jd.com-cert.pem
    │       │   └── tls
    │       │       ├── ca.crt
    │       │       ├── client.crt
    │       │       └── client.key
    │       └── User1@jd.com
    │           ├── msp
    │           │   ├── admincerts
    │           │   │   └── User1@jd.com-cert.pem
    │           │   ├── cacerts
    │           │   │   └── ca.jd.com-cert.pem
    │           │   ├── keystore
    │           │   │   └── e83862c8e78509f2a4362d3282214421179fa47f3d655f75cb3539d5534f7494_sk
    │           │   ├── signcerts
    │           │   │   └── User1@jd.com-cert.pem
    │           │   └── tlscacerts
    │           │       └── tlsca.jd.com-cert.pem
    │           └── tls
    │               ├── ca.crt
    │               ├── client.crt
    │               └── client.key
    └── taobao.com
        ├── ca
        │   ├── 4a31791b9fade54ab70496f03169707f6b9643c04d1bc734da15b0c625628865_sk
        │   └── ca.taobao.com-cert.pem
        ├── msp
        │   ├── admincerts
        │   │   └── Admin@taobao.com-cert.pem
        │   ├── cacerts
        │   │   └── ca.taobao.com-cert.pem
        │   └── tlscacerts
        │       └── tlsca.taobao.com-cert.pem
        ├── peers
        │   ├── peer0.taobao.com
        │   │   ├── msp
        │   │   │   ├── admincerts
        │   │   │   │   └── Admin@taobao.com-cert.pem
        │   │   │   ├── cacerts
        │   │   │   │   └── ca.taobao.com-cert.pem
        │   │   │   ├── keystore
        │   │   │   │   └── 914648b8c4dc4783b0505a22b5c7630e424c3cf8dd54e2fe05b47dc321a4e61b_sk
        │   │   │   ├── signcerts
        │   │   │   │   └── peer0.taobao.com-cert.pem
        │   │   │   └── tlscacerts
        │   │   │       └── tlsca.taobao.com-cert.pem
        │   │   └── tls
        │   │       ├── ca.crt
        │   │       ├── server.crt
        │   │       └── server.key
        │   └── peer1.taobao.com
        │       ├── msp
        │       │   ├── admincerts
        │       │   │   └── Admin@taobao.com-cert.pem
        │       │   ├── cacerts
        │       │   │   └── ca.taobao.com-cert.pem
        │       │   ├── keystore
        │       │   │   └── 3eef8defc07afb547e94f08702a5b30807d2e2a672e3d437bfb54dd1590b0fa7_sk
        │       │   ├── signcerts
        │       │   │   └── peer1.taobao.com-cert.pem
        │       │   └── tlscacerts
        │       │       └── tlsca.taobao.com-cert.pem
        │       └── tls
        │           ├── ca.crt
        │           ├── server.crt
        │           └── server.key
        ├── tlsca
        │   ├── 296a941f625974153aa5ab6cf57b0933023aaa13b0e4363a7378e5c527de26a1_sk
        │   └── tlsca.taobao.com-cert.pem
        └── users
            ├── Admin@taobao.com
            │   ├── msp
            │   │   ├── admincerts
            │   │   │   └── Admin@taobao.com-cert.pem
            │   │   ├── cacerts
            │   │   │   └── ca.taobao.com-cert.pem
            │   │   ├── keystore
            │   │   │   └── a2af975d659f77182b2aca318321797d281036f085dda9799ab79b6400e5e970_sk
            │   │   ├── signcerts
            │   │   │   └── Admin@taobao.com-cert.pem
            │   │   └── tlscacerts
            │   │       └── tlsca.taobao.com-cert.pem
            │   └── tls
            │       ├── ca.crt
            │       ├── client.crt
            │       └── client.key
            └── User1@taobao.com
                ├── msp
                │   ├── admincerts
                │   │   └── User1@taobao.com-cert.pem
                │   ├── cacerts
                │   │   └── ca.taobao.com-cert.pem
                │   ├── keystore
                │   │   └── c65d45e1c7e1070e3f1b00bd8ac41e91d2bfaea10a769d75b9599590791ccc02_sk
                │   ├── signcerts
                │   │   └── User1@taobao.com-cert.pem
                │   └── tlscacerts
                │       └── tlsca.taobao.com-cert.pem
                └── tls
                    ├── ca.crt
                    ├── client.crt
                    └── client.key

109 directories, 101 files
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br></div></div><p>总结：在这个环节中，我们假设 <code>QQ</code> 作为一个运营方，提供了 1 个 Orderer 节点 <code>orderer.qq.com</code> 来创建联盟链的基础设施， 而 <code>Taobao</code> 和 <code>JD</code> 则是作为组织成员加入到链中，各自提供 2 个 Peer 节点 <code>peer0.xx.com</code> 和 <code>peer1.xx.com</code> 参与工作，以及还各自创建了 2 个组织用户 <code>Admin</code> 和 <code>User1</code> 。然后我们使用 <code>crypto-config.yaml</code> 文件和 <code>cryptogen</code> 工具为其定义所需要的证书文件以供后续使用。</p> <p>4、创建排序通道创世区块</p> <p>我们可以使用 <code>configtx.yaml</code> 文件和 <code>configtxgen</code> 工具轻松地创建通道的配置。<code>configtx.yaml</code> 文件可以以易于理解和编辑的 <code>yaml</code> 格式来构建通道配置所需的信息。<code>configtxgen</code> 工具通过读取 <code>configtx.yaml</code> 文件中的信息，将其转成 Fabric 可以读取的 <code>protobuf</code> 格式。</p> <p>先来创建 <code>configtx.yaml</code> 文件，内容如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 定义组织机构实体
Organizations:
  - &amp;QQ
    Name: QQ # 组织的名称
    ID: QQMSP # 组织的 MSPID
    MSPDir: crypto-config/ordererOrganizations/qq.com/msp #组织的证书相对位置（生成的crypto-config目录)

  - &amp;Taobao
    Name: Taobao
    ID: TaobaoMSP
    MSPDir: crypto-config/peerOrganizations/taobao.com/msp
    AnchorPeers: # 组织锚节点的配置
      - Host: peer0.taobao.com
        Port: 7051

  - &amp;JD
    Name: JD
    ID: JDMSP
    MSPDir: crypto-config/peerOrganizations/jd.com/msp
    AnchorPeers: # 组织锚节点的配置
      - Host: peer0.jd.com
        Port: 7051

# 定义了排序服务的相关参数，这些参数将用于创建创世区块
Orderer: &amp;OrdererDefaults
  # 排序节点类型用来指定要启用的排序节点实现，不同的实现对应不同的共识算法
  OrdererType: solo # 共识机制
  Addresses: # Orderer 的域名（用于连接）
    - orderer.qq.com:7050
  BatchTimeout: 2s # 出块时间间隔
  BatchSize: # 用于控制每个block的信息量
    MaxMessageCount: 10 #每个区块的消息个数
    AbsoluteMaxBytes: 99 MB #每个区块最大的信息大小
    PreferredMaxBytes: 512 KB #每个区块包含的一条信息最大长度
  Organizations:

# 定义Peer组织如何与应用程序通道交互的策略
# 默认策略：所有Peer组织都将能够读取数据并将数据写入账本
Application: &amp;ApplicationDefaults
  Organizations:

# 用来定义用于 configtxgen 工具的配置入口
# 将 Profile 参数（ TwoOrgsOrdererGenesis 或 TwoOrgsChannel ）指定为 configtxgen 工具的参数
Profiles:
  #  TwoOrgsOrdererGenesis配置文件用于创建系统通道创世块
  #  该配置文件创建一个名为SampleConsortium的联盟
  #  该联盟在configtx.yaml文件中包含两个Peer组织Taobao和JD
  TwoOrgsOrdererGenesis:
    Orderer:
      &lt;&lt;: *OrdererDefaults
      Organizations:
        - *QQ
    Consortiums:
      SampleConsortium:
        Organizations:
          - *Taobao
          - *JD
  # 使用TwoOrgsChannel配置文件创建应用程序通道
  TwoOrgsChannel:
    Consortium: SampleConsortium
    Application:
      &lt;&lt;: *ApplicationDefaults
      Organizations:
        - *Taobao
        - *JD
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>执行 <code>configtxgen</code> 命令，并指定 Profile 为 <code>TwoOrgsOrdererGenesis</code> 参数：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./config/genesis.block -channelID firstchannel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>排序区块是排序服务的创世区块，通过以上命令就可以预先生成创世区块的 <code>protobuf</code> 格式的配置文件 <code>./config/genesis.block</code> 了。这一步也是为后续做准备用的。</p> <p>5、创建通道配置交易</p> <p>接下来，我们需要继续使用 <code>configtxgen</code> 根据去创建通道的交易配置，和第 4 步不同的是，这次需要指定 Profile 为 <code>TwoOrgsChannel</code> 参数。</p> <p>生成通道配置事务 <code>./config/appchannel.tx</code> ：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./config/appchannel.tx -channelID appchannel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>为 <code>Taobao</code> 组织定义锚节点，生成 <code>./config/TaobaoAnchor.tx</code> ：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./config/TaobaoAnchor.tx -channelID appchannel -asOrg Taobao
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>为 <code>JD</code> 组织定义锚节点，生成 <code>./config/JDAnchor.tx</code> ：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./config/JDAnchor.tx -channelID appchannel -asOrg JD
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当然，这一步也是为后续使用做准备的。不过至此，需要准备的配置都齐了。</p> <p>来看看现在 <code>config</code> 文件夹都有什么：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ tree config
config
├── JDAnchor.tx
├── TaobaoAnchor.tx
├── appchannel.tx
└── genesis.block

0 directories, 4 files
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>6、创建并启动各组织的节点</p> <p>我们说过：我们假设 <code>QQ</code> 作为一个运营方，提供了 1 个 Orderer 节点 <code>orderer.qq.com</code> 来创建联盟链的基础设施， 而 <code>Taobao</code> 和 <code>JD</code> 则是作为组织成员加入到链中，各自提供 2 个 Peer 节点 <code>peer0.xx.com</code> 和 <code>peer1.xx.com</code> 参与工作。</p> <p>现在这些组织及其节点所需要的配置已经准备好了。我们接下来就可以使用 Docker Compose 来模拟启动这些节点服务。</p> <p>由于这些节点之间需要互相通信，所以我们需要将这些节点都放入到一个 Docker 网络中，以 <code>fabric_network</code> 为例。</p> <p><code>docker-compose.yaml</code> 的内容如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>version: '2.1'

volumes:
  orderer.qq.com:
  peer0.taobao.com:
  peer1.taobao.com:
  peer0.jd.com:
  peer1.jd.com:

networks:
  fabric_network:
    name: fabric_network

services:
  # 排序服务节点
  orderer.qq.com:
    container_name: orderer.qq.com
    image: hyperledger/fabric-orderer:1.4.12
    environment:
      - GODEBUG=netdns=go
      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
      - ORDERER_GENERAL_GENESISMETHOD=file
      - ORDERER_GENERAL_GENESISFILE=/etc/hyperledger/config/genesis.block # 注入创世区块
      - ORDERER_GENERAL_LOCALMSPID=QQMSP
      - ORDERER_GENERAL_LOCALMSPDIR=/etc/hyperledger/orderer/msp # 证书相关
    command: orderer
    ports:
      - &quot;7050:7050&quot;
    volumes: # 挂载由cryptogen和configtxgen生成的证书文件以及创世区块
      - ./config/genesis.block:/etc/hyperledger/config/genesis.block
      - ./crypto-config/ordererOrganizations/qq.com/orderers/orderer.qq.com/:/etc/hyperledger/orderer
      - orderer.qq.com:/var/hyperledger/production/orderer
    networks:
      - fabric_network

  #  Taobao 组织 peer0 节点
  peer0.taobao.com:
    extends:
      file: docker-compose-base.yaml
      service: peer-base
    container_name: peer0.taobao.com
    environment:
      - CORE_PEER_ID=peer0.taobao.com
      - CORE_PEER_LOCALMSPID=TaobaoMSP
      - CORE_PEER_ADDRESS=peer0.taobao.com:7051
    ports:
      - &quot;7051:7051&quot; # grpc服务端口
      - &quot;7053:7053&quot; # eventhub端口
    volumes:
      - ./crypto-config/peerOrganizations/taobao.com/peers/peer0.taobao.com:/etc/hyperledger/peer
      - peer0.taobao.com:/var/hyperledger/production
    depends_on:
      - orderer.qq.com

  #  Taobao 组织 peer1 节点
  peer1.taobao.com:
    extends:
      file: docker-compose-base.yaml
      service: peer-base
    container_name: peer1.taobao.com
    environment:
      - CORE_PEER_ID=peer1.taobao.com
      - CORE_PEER_LOCALMSPID=TaobaoMSP
      - CORE_PEER_ADDRESS=peer1.taobao.com:7051
    ports:
      - &quot;17051:7051&quot;
      - &quot;17053:7053&quot;
    volumes:
      - ./crypto-config/peerOrganizations/taobao.com/peers/peer1.taobao.com:/etc/hyperledger/peer
      - peer1.taobao.com:/var/hyperledger/production
    depends_on:
      - orderer.qq.com

  #  JD 组织 peer0 节点
  peer0.jd.com:
    extends:
      file: docker-compose-base.yaml
      service: peer-base
    container_name: peer0.jd.com
    environment:
      - CORE_PEER_ID=peer0.jd.com
      - CORE_PEER_LOCALMSPID=JDMSP
      - CORE_PEER_ADDRESS=peer0.jd.com:7051
    ports:
      - &quot;27051:7051&quot;
      - &quot;27053:7053&quot;
    volumes:
      - ./crypto-config/peerOrganizations/jd.com/peers/peer0.jd.com:/etc/hyperledger/peer
      - peer0.jd.com:/var/hyperledger/production
    depends_on:
      - orderer.qq.com

  #  JD 组织 peer1 节点
  peer1.jd.com:
    extends:
      file: docker-compose-base.yaml
      service: peer-base
    container_name: peer1.jd.com
    environment:
      - CORE_PEER_ID=peer1.jd.com
      - CORE_PEER_LOCALMSPID=JDMSP
      - CORE_PEER_ADDRESS=peer1.jd.com:7051
    ports:
      - &quot;37051:7051&quot;
      - &quot;37053:7053&quot;
    volumes:
      - ./crypto-config/peerOrganizations/jd.com/peers/peer1.jd.com:/etc/hyperledger/peer
      - peer1.jd.com:/var/hyperledger/production
    depends_on:
      - orderer.qq.com

  # 客户端节点
  cli:
    container_name: cli
    image: hyperledger/fabric-tools:1.4.12
    tty: true
    environment:
      # go 环境设置
      - GO111MODULE=auto
      - GOPROXY=https://goproxy.cn
      - CORE_PEER_ID=cli
    command: /bin/bash
    volumes:
      - ./config:/etc/hyperledger/config
      - ./crypto-config/peerOrganizations/taobao.com/:/etc/hyperledger/peer/taobao.com
      - ./crypto-config/peerOrganizations/jd.com/:/etc/hyperledger/peer/jd.com
      - ./../chaincode:/opt/gopath/src/chaincode # 链码路径注入
    networks:
      - fabric_network
    depends_on:
      - orderer.qq.com
      - peer0.taobao.com
      - peer1.taobao.com
      - peer0.jd.com
      - peer1.jd.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br></div></div><p>为了方便，这里我还定义了一个 <code>docker-compose-base.yaml</code> 作为 Peer 节点的公共模板，内容如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>version: '2.1'

services:
  peer-base: # peer的公共服务
    image: hyperledger/fabric-peer:1.4.12
    environment:
      - GODEBUG=netdns=go
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_LOGGING_PEER=info
      - CORE_CHAINCODE_LOGGING_LEVEL=INFO
      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/peer/msp # msp证书（节点证书）
      - CORE_LEDGER_STATE_STATEDATABASE=goleveldb # 状态数据库的存储引擎（or CouchDB）
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=fabric_network # docker 网络
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric
    command: peer node start
    networks:
      - fabric_network
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>注意观察，在 <code>volumes</code> 配置项中，我们将 <code>config</code> 和 <code>crypto-config</code> 内的配置文件都挂载到相对应的节点中了。并且在 peer 的公共服务中，我们还挂载了 <code>/var/run/docker.sock</code> 文件，有了该文件，在容器内就可以向其发送 http 请求和 Docker Daemon 通信，通俗理解，就是有了它，就可以在容器内操作宿主机的 Docker 了，比如在容器内控制 Docker 再启动一个容器出来。而这，就是为了后面可以部署智能合约（节点部署链码其实就是启动一个链码容器）。</p> <p>现在继续将这些节点服务启动起来：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker-compose up -d
Creating network &quot;fabric_network&quot; with the default driver
Creating volume &quot;network_orderer.qq.com&quot; with default driver
Creating volume &quot;network_peer0.taobao.com&quot; with default driver
Creating volume &quot;network_peer1.taobao.com&quot; with default driver
Creating volume &quot;network_peer0.jd.com&quot; with default driver
Creating volume &quot;network_peer1.jd.com&quot; with default driver
Creating orderer.qq.com ... done
Creating peer1.taobao.com ... done
Creating peer0.jd.com     ... done
Creating peer1.jd.com     ... done
Creating peer0.taobao.com ... done
Creating cli              ... done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>哦对了，除了必须的节点服务，我还启动了一个 <code>cli</code> 服务，来自 <code>hyperledger/fabric-tools</code> 镜像，这个其实就是集成了前面第 1 步提到的 fabric 工具的容器，我们接下来的命令执行就使用这个容器内的工具来完成了，你也可以继续使用自己下载的二进制工具，只是个人觉得环境配置起来会比较麻烦。</p> <p>7、为 <code>cli</code> 服务配置环境</p> <p>接下来我们要使用 <code>cli</code> 服务来执行 <code>peer</code> 命令，所以要为其先配置一下环境变量，使用四个不同的变量 <code>TaobaoPeer0Cli</code>、<code>TaobaoPeer1Cli</code>、<code>JDPeer0Cli</code>、<code>JDPeer1Cli</code> ，代表 <code>cli</code> 服务代表着不同的节点：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ TaobaoPeer0Cli=&quot;CORE_PEER_ADDRESS=peer0.taobao.com:7051 CORE_PEER_LOCALMSPID=TaobaoMSP CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/peer/taobao.com/users/Admin@taobao.com/msp&quot;
$ TaobaoPeer1Cli=&quot;CORE_PEER_ADDRESS=peer1.taobao.com:7051 CORE_PEER_LOCALMSPID=TaobaoMSP CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/peer/taobao.com/users/Admin@taobao.com/msp&quot;
$ JDPeer0Cli=&quot;CORE_PEER_ADDRESS=peer0.jd.com:7051 CORE_PEER_LOCALMSPID=JDMSP CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/peer/jd.com/users/Admin@jd.com/msp&quot;
$ JDPeer1Cli=&quot;CORE_PEER_ADDRESS=peer1.jd.com:7051 CORE_PEER_LOCALMSPID=JDMSP CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/peer/jd.com/users/Admin@jd.com/msp&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>8、开始创建通道</p> <p>通道主要用于实现区块链网络中业务的隔离。一个联盟中可以有多个通道，每个通道可代表一项业务，并且对应一套账本。通道内的成员为业务参与方（即联盟内的组织），一个组织可以加入多个通道。</p> <p>我们现在有请 <code>Taobao</code> 组织的 <code>peer0</code> 节点来创建一个通道 <code>appchannel</code> ：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker exec cli bash -c &quot;$TaobaoPeer0Cli peer channel create -o orderer.qq.com:7050 -c appchannel -f /etc/hyperledger/config/appchannel.tx&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通道就相当于“群聊”， <code>Taobao</code> 组织的 <code>peer0</code> 节点创建了一个名称为 <code>appchannel</code> 的“群聊”。</p> <p>9、将所有节点加入通道</p> <p>将所有的节点都加入到通道 <code>appchannel</code> 中（正常是按需加入）：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker exec cli bash -c &quot;$TaobaoPeer0Cli peer channel join -b appchannel.block&quot;
$ docker exec cli bash -c &quot;$TaobaoPeer1Cli peer channel join -b appchannel.block&quot;
$ docker exec cli bash -c &quot;$JDPeer0Cli peer channel join -b appchannel.block&quot;
$ docker exec cli bash -c &quot;$JDPeer1Cli peer channel join -b appchannel.block&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这时相当于大家都加入到了 <code>appchannel</code> “群聊”中，之后大家都可以在里面“聊天”了。</p> <p>10、更新锚节点</p> <p>锚节点是必需的。普通节点只能发现本组织下的其它节点，而锚节点可以跨组织服务发现到其它组织下的节点，建议每个组织都选择至少一个锚节点。</p> <p>利用之前准备好的配置文件，向通道更新锚节点：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker exec cli bash -c &quot;$TaobaoPeer0Cli peer channel update -o orderer.qq.com:7050 -c appchannel -f /etc/hyperledger/config/TaobaoAnchor.tx&quot;
$ docker exec cli bash -c &quot;$JDPeer0Cli peer channel update -o orderer.qq.com:7050 -c appchannel -f /etc/hyperledger/config/JDAnchor.tx&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这样，<code>Taobao</code> 和 <code>JD</code> 组织间的节点就都可以互相发现了。</p> <p>到这里，我们的区块链网络基本已经搭建好了，但是还差最关键的智能合约。一个没有智能合约的通道是没有灵魂的，啥事都做不了。</p> <h3 id="编写智能合约"><a href="#编写智能合约" class="header-anchor">#</a> 编写智能合约</h3> <p>fabric 的智能合约称为链码，编写智能合约也就是编写链码。</p> <p>链码其实很简单，可以由 Go 、 node.js 、或者 Java 编写，其实只是实现一些预定义的接口。</p> <p>以 Go 为例，创建一个 <code>main.go</code> 文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>package main

import (
 &quot;fmt&quot;

 &quot;github.com/hyperledger/fabric/core/chaincode/shim&quot;
 pb &quot;github.com/hyperledger/fabric/protos/peer&quot;
)

type MyChaincode struct {
}

// Init 初始化时会执行该方法
func (c *MyChaincode) Init(stub shim.ChaincodeStubInterface) pb.Response {
 fmt.Println(&quot;链码初始化&quot;)
 return shim.Success(nil)
}

// Invoke 智能合约的功能函数定义
func (c *MyChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response {
 funcName, args := stub.GetFunctionAndParameters()
 switch funcName {

 default:
  return shim.Error(fmt.Sprintf(&quot;没有该功能: %s&quot;, funcName))
 }
}

func main() {
 err := shim.Start(new(MyChaincode))
 if err != nil {
  panic(err)
 }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>我们定义的 <code>MyChaincode</code> 结构体实现了 <code>shim.Chaincode</code> 接口：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// Chaincode interface must be implemented by all chaincodes. The fabric runs
// the transactions by calling these functions as specified.
type Chaincode interface {
 // Init is called during Instantiate transaction after the chaincode container
 // has been established for the first time, allowing the chaincode to
 // initialize its internal data
 Init(stub ChaincodeStubInterface) pb.Response

 // Invoke is called to update or query the ledger in a proposal transaction.
 // Updated state variables are not committed to the ledger until the
 // transaction is committed.
 Invoke(stub ChaincodeStubInterface) pb.Response
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>然后在启动入口 <code>main</code> 函数中调用 <code>shim.Start(new(MyChaincode))</code> 就完成了链码的启动，没错，就是这么简单。</p> <p>我们知道链码其实就是用来处理区块链网络中的成员一致同意的业务逻辑。比如 <code>Taobao</code> 和 <code>JD</code> 规定了一个规则，将其编写成链码，后面双方就只能遵循这个规则了，因为链码到时候即部署在你的节点，也会部署在我的节点上，你偷偷改了逻辑，我的节点不会认可你的，这也正是区块链的作用之一。</p> <p>链码的功能定义在 <code>Invoke</code> 方法中。</p> <p>一个简易的示例如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>package main

import (
 &quot;encoding/json&quot;
 &quot;errors&quot;
 &quot;fmt&quot;
 &quot;strconv&quot;

 &quot;github.com/hyperledger/fabric/core/chaincode/shim&quot;
 pb &quot;github.com/hyperledger/fabric/protos/peer&quot;
)

type MyChaincode struct {
}

// Init 初始化时会执行该方法
func (c *MyChaincode) Init(stub shim.ChaincodeStubInterface) pb.Response {
 fmt.Println(&quot;链码初始化&quot;)
 // 假设A有1000元，以复合主键 userA 的形式写入账本
 err := WriteLedger(stub, map[string]interface{}{&quot;name&quot;: &quot;A&quot;, &quot;balance&quot;: 1000}, &quot;user&quot;, []string{&quot;A&quot;})
 if err != nil {
  return shim.Error(err.Error())
 }
 // 假设B有1000元，以复合主键 userB 的形式写入账本
 err = WriteLedger(stub, map[string]interface{}{&quot;name&quot;: &quot;B&quot;, &quot;balance&quot;: 1000}, &quot;user&quot;, []string{&quot;B&quot;})
 if err != nil {
  return shim.Error(err.Error())
 }
 return shim.Success(nil)
}

// Invoke 智能合约的功能函数定义
func (c *MyChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response {
 funcName, args := stub.GetFunctionAndParameters()
 switch funcName {
 case &quot;query&quot;:
  return query(stub, args)
 case &quot;transfer&quot;:
  return transfer(stub, args)
 default:
  return shim.Error(fmt.Sprintf(&quot;没有该功能: %s&quot;, funcName))
 }
}

func query(stub shim.ChaincodeStubInterface, args []string) pb.Response {
 // 如果 args 为空，则表示查询所有 user
 results, err := ReadLedger(stub, &quot;user&quot;, args)
 if err != nil {
  return shim.Error(err.Error())
 }
 var users []map[string]interface{}
 for _, result := range results {
  var user map[string]interface{}
  if err = json.Unmarshal(result, &amp;user); err != nil {
   return shim.Error(err.Error())
  }
  users = append(users, user)
 }
 usersByte, err := json.Marshal(&amp;users)
 if err != nil {
  return shim.Error(err.Error())
 }
 return shim.Success(usersByte)
}

func transfer(stub shim.ChaincodeStubInterface, args []string) pb.Response {
 // 验证参数
 if len(args) != 3 {
  return shim.Error(&quot;参数个数不满足&quot;)
 }
 from := args[0]
 to := args[1]
 money, err := strconv.ParseFloat(args[2], 64)
 if err != nil {
  return shim.Error(err.Error())
 }
 // 从账本查询 from 用户
 fromResults, err := ReadLedger(stub, &quot;user&quot;, []string{from})
 if err != nil {
  return shim.Error(err.Error())
 }
 if len(fromResults) != 1 {
  return shim.Error(&quot;没有该用户 &quot; + from)
 }
 var fromUser map[string]interface{}
 if err = json.Unmarshal(fromResults[0], &amp;fromUser); err != nil {
  return shim.Error(err.Error())
 }
 // 从账本查询 to 用户
 toResults, err := ReadLedger(stub, &quot;user&quot;, []string{to})
 if err != nil {
  return shim.Error(err.Error())
 }
 if len(toResults) != 1 {
  return shim.Error(&quot;没有该用户 &quot; + to)
 }
 var toUser map[string]interface{}
 if err = json.Unmarshal(toResults[0], &amp;toUser); err != nil {
  return shim.Error(err.Error())
 }
 // from 用户扣除余额
 if money &gt; fromUser[&quot;balance&quot;].(float64) {
  return shim.Error(&quot;余额不足&quot;)
 }
 fromUser[&quot;balance&quot;] = fromUser[&quot;balance&quot;].(float64) - money
 // to 用户增加余额
 toUser[&quot;balance&quot;] = toUser[&quot;balance&quot;].(float64) + money
 // 写回账本
 err = WriteLedger(stub, fromUser, &quot;user&quot;, []string{from})
 if err != nil {
  return shim.Error(err.Error())
 }
 err = WriteLedger(stub, toUser, &quot;user&quot;, []string{to})
 if err != nil {
  return shim.Error(err.Error())
 }
 return shim.Success([]byte(&quot;ok&quot;))
}

func main() {
 err := shim.Start(new(MyChaincode))
 if err != nil {
  panic(err)
 }
}

// WriteLedger 写入账本
// obj 为要写入的数据
// objectType和keys 共同组成复合主键
func WriteLedger(stub shim.ChaincodeStubInterface, obj interface{}, objectType string, keys []string) error {
 //创建复合主键
 var key string
 if val, err := stub.CreateCompositeKey(objectType, keys); err != nil {
  return errors.New(fmt.Sprintf(&quot;%s-创建复合主键出错 %s&quot;, objectType, err.Error()))
 } else {
  key = val
 }
 bytes, err := json.Marshal(obj)
 if err != nil {
  return err
 }
 //写入区块链账本
 if err := stub.PutState(key, bytes); err != nil {
  return errors.New(fmt.Sprintf(&quot;%s-写入区块链账本出错: %s&quot;, objectType, err.Error()))
 }
 return nil
}

// ReadLedger 根据复合主键查询账本数据(适合获取全部或指定的数据)
// objectType和keys 共同组成复合主键
func ReadLedger(stub shim.ChaincodeStubInterface, objectType string, keys []string) (results [][]byte, err error) {
 // 通过主键从区块链查找相关的数据，相当于对主键的模糊查询
 resultIterator, err := stub.GetStateByPartialCompositeKey(objectType, keys)
 if err != nil {
  return nil, errors.New(fmt.Sprintf(&quot;%s-获取全部数据出错: %s&quot;, objectType, err))
 }
 defer resultIterator.Close()

 //检查返回的数据是否为空，不为空则遍历数据，否则返回空数组
 for resultIterator.HasNext() {
  val, err := resultIterator.Next()
  if err != nil {
   return nil, errors.New(fmt.Sprintf(&quot;%s-返回的数据出错: %s&quot;, objectType, err))
  }

  results = append(results, val.GetValue())
 }
 return results, nil
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br></div></div><p>在这段链码中，初始化的时候我们假设有用户 <code>A</code> 和 <code>B</code> ，并且都各自有 <code>1000</code> 元余额，我们在 <code>Invoke</code> 方法中为其定义了两个功能函数 <code>query</code> 和 <code>transfer</code> 。 其中 <code>query</code> 函数可以查询 <code>A</code> 和 <code>B</code> 或指定用户的余额信息， <code>transfer</code> 函数可以通过传入转账人，被转账人，金额，三个参数来实现转账功能。例如 <code>{&quot;Args&quot;:[&quot;transfer&quot;,&quot;A&quot;,&quot;B&quot;,&quot;100.0&quot;]}</code> 代表 <code>A</code> 向 <code>B</code> 转账 <code>100</code> 元。</p> <h3 id="部署链码"><a href="#部署链码" class="header-anchor">#</a> 部署链码</h3> <p>我们将刚刚编写的智能合约也就是链码安装到区块链网络中，同样是借助 <code>cli</code> 服务，我们在 <code>Taobao</code> 组织的 <code>peer0</code> 节点和 <code>JD</code> 组织的 <code>peer0</code> 节点上都安装上链码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker exec cli bash -c &quot;$TaobaoPeer0Cli peer chaincode install -n fabric-realty -v 1.0.0 -l golang -p chaincode&quot;
$ docker exec cli bash -c &quot;$JDPeer0Cli peer chaincode install -n fabric-realty -v 1.0.0 -l golang -p chaincode&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>其中 <code>-n</code> 参数是链码名称，可以自己随便设置，<code>-v</code> 是链码版本号，<code>-p</code> 是链码的目录（我们已经将链码挂载到 <code>cli</code> 容器中了，在 <code>/opt/gopath/src/</code> 目录下）</p> <p>链码安装后，还需要实例化后才可以使用，只需要在任意一个节点实例化就可以了，以 <code>Taobao</code> 组织的 <code>peer0</code> 节点为例：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker exec cli bash -c &quot;$TaobaoPeer0Cli peer chaincode instantiate -o orderer.qq.com:7050 -C appchannel -n fabric-realty -l golang -v 1.0.0 -c '{\&quot;Args\&quot;:[\&quot;init\&quot;]}' -P \&quot;AND ('TaobaoMSP.member','JDMSP.member')\&quot;&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>实例化链码主要就是传入 <code>{&quot;Args&quot;:[&quot;init&quot;]}</code> 参数，此时会调用我们编写的 <code>func (c *MyChaincode) Init</code> 方法，进行链码的初始化。其中 <code>-P</code> 参数用于指定链码的背书策略，<code>AND ('TaobaoMSP.member','JDMSP.member')</code> 代表链码的写入操作需要同时得到 <code>Taobao</code>和 <code>JD</code> 组织成员的背书才允许通过。<code>AND</code> 也可以替换成 <code>OR</code>，代表任意一组织成员背书即可，更多具体用法，可以去看官方文档。</p> <p>链码实例化成功之后就会启动链码容器，而启动的方法，就是我们之前提过的 peer 节点服务挂载了 <code>/var/run/docker.sock</code> 文件。</p> <p>查看启动的链码容器：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker ps -a | awk '($2 ~ /dev-peer.*fabric-realty.*/) {print $2}'
dev-peer0.taobao.com-fabric-realty-1.0.0-4f127a0415dd835529133a69b480ce24581dd5ddcaf18426ecc1d3dfb02b4670
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>因为我们使用 <code>Taobao</code> 组织的 <code>peer0</code> 节点实例化链码，所以此时还只有这个节点的链码容器启动起来了。</p> <p>我们可以试着使用 <code>cli</code> 服务去调用链码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker exec cli bash -c &quot;$TaobaoPeer0Cli peer chaincode invoke -C appchannel -n fabric-realty -c '{\&quot;Args\&quot;:[\&quot;query\&quot;]}'&quot;
2022-03-22 21:13:40.152 UTC [chaincodeCmd] InitCmdFactory -&gt; INFO 001 Retrieved channel (appchannel) orderer endpoint: orderer.qq.com:7050
2022-03-22 21:13:40.157 UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO 002 Chaincode invoke successful. result: status:200 payload:&quot;[{\
&quot;balance\&quot;:1000,\&quot;name\&quot;:\&quot;A\&quot;},{\&quot;balance\&quot;:1000,\&quot;name\&quot;:\&quot;B\&quot;}]&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当然，使用<code>JD</code>组织的节点也是可以的：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker exec cli bash -c &quot;$JDPeer0Cli peer chaincode invoke -C appchannel -n fabric-realty -c '{\&quot;Args\&quot;:[\&quot;query\&quot;]}'&quot;
2022-03-22 21:14:45.397 UTC [chaincodeCmd] InitCmdFactory -&gt; INFO 001 Retrieved channel (appchannel) orderer endpoint: orderer.qq.com:7050
2022-03-22 21:14:45.402 UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO 002 Chaincode invoke successful. result: status:200 payload:&quot;[{\
&quot;balance\&quot;:1000,\&quot;name\&quot;:\&quot;A\&quot;},{\&quot;balance\&quot;:1000,\&quot;name\&quot;:\&quot;B\&quot;}]&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>此时，因为我们查询了 <code>JD</code> 组织的 <code>peer0</code> 节点上的链码，所以对应的链码容器也会启动起来了，再次查看启动的链码容器：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker ps -a | awk '($2 ~ /dev-peer.*fabric-realty.*/) {print $2}'
dev-peer0.jd.com-fabric-realty-1.0.0-5c5e915cdcd47324151383f9619a0ff9a33283d969555e6029aa256cc389ebc9
dev-peer0.taobao.com-fabric-realty-1.0.0-4f127a0415dd835529133a69b480ce24581dd5ddcaf18426ecc1d3dfb02b4670
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在，我们的智能合约就成功部署到区块链网络的通道中了。</p> <h3 id="编写应用程序"><a href="#编写应用程序" class="header-anchor">#</a> 编写应用程序</h3> <p>在部署链码之后，我们是使用 <code>cli</code> 服务去调用的，但这种方式一般只是作为验证使用，更多情况下，应该是我们自己编写应用程序集成 fabric 提供的 <code>SDK</code> 去调用。</p> <p>Go 语言可以使用官方的 <code>github.com/hyperledger/fabric-sdk-go</code> 库。</p> <p>这个 SDK 使用起来也很简单。</p> <p>第一步调用其 <code>New</code> 方法创建一个 <code>FabricSDK</code> 实例，后续使用这个实例就可以调用操作合约的方法了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// New 根据提供的一组选项初始化 SDK
// ConfigOptions 提供应用程序配置
func New(configProvider core.ConfigProvider, opts ...Option) (*FabricSDK, error) {
 pkgSuite := defPkgSuite{}
 return fromPkgSuite(configProvider, &amp;pkgSuite, opts...)
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>其中 <code>configProvider</code> 可以从 <code>Reader</code>(实现了<code>io.Reader</code>接口的实例) 、 <code>File</code>(文件) 或 <code>Raw</code>(<code>[]byte</code>) 获取。我们选择最简单的文件方式。</p> <p>创建一个 <code>config.yaml</code> ，配置如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>version: 1.0.0

# GO SDK 客户端配置
client:
  # 客户端所属的组织，必须是organizations定义的组织
  organization: JD
  # 日志级别
  logging:
    level: info
  # MSP证书的根路径
  cryptoconfig:
    path: /network/crypto-config

# 通道定义
channels:
  appchannel:
    orderers:
      - orderer.qq.com
    peers:
      peer0.jd.com:
        endorsingPeer: true
        chaincodeQuery: true
        ledgerQuery: true
        eventSource: true
      peer1.jd.com:
        endorsingPeer: true
        chaincodeQuery: true
        ledgerQuery: true
        eventSource: true

# 组织配置
organizations:
  JD:
    mspid: &quot;JDMSP&quot;
    cryptoPath: peerOrganizations/jd.com/users/{username}@jd.com/msp
    peers:
      - peer0.jd.com
      - peer1.jd.com

# orderer节点列表
orderers:
  orderer.qq.com:
    url: orderer.qq.com:7050
    # 传递给gRPC客户端构造函数
    grpcOptions:
      ssl-target-name-override: orderer.qq.com
      keep-alive-time: 0s
      keep-alive-timeout: 20s
      keep-alive-permit: false
      fail-fast: false
      allow-insecure: true

# peers节点列表
peers:
  # peer节点定义，可以定义多个
  peer0.jd.com:
    # URL用于发送背书和查询请求
    url: peer0.jd.com:7051
    # 传递给gRPC客户端构造函数
    grpcOptions:
      ssl-target-name-override: peer0.jd.com
      keep-alive-time: 0s
      keep-alive-timeout: 20s
      keep-alive-permit: false
      fail-fast: false
      allow-insecure: true
  peer1.jd.com:
    url: peer1.jd.com:7051
    grpcOptions:
      ssl-target-name-override: peer1.jd.com
      keep-alive-time: 0s
      keep-alive-timeout: 20s
      keep-alive-permit: false
      fail-fast: false
      allow-insecure: true
  peer0.taobao.com:
    url: peer0.taobao.com:7051
    grpcOptions:
      ssl-target-name-override: peer0.taobao.com
      keep-alive-time: 0s
      keep-alive-timeout: 20s
      keep-alive-permit: false
      fail-fast: false
      allow-insecure: true
  peer1.taobao.com:
    url: peer1.taobao.com:7051
    grpcOptions:
      ssl-target-name-override: peer1.taobao.com
      keep-alive-time: 0s
      keep-alive-timeout: 20s
      keep-alive-permit: false
      fail-fast: false
      allow-insecure: true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><p>我们假定是 <code>JD</code> 组织来编写这个应用程序，该配置主要就是用于验证 <code>JD</code> 组织及其节点的身份。</p> <p>其中组织配置中 <code>{username}</code> 为动态传递， MSP 证书的根路径我们后续会挂载进去。</p> <p>现在开始编写代码，我们先来实例化 SDK ，创建 <code>sdk.go</code>：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>package main

import (
 &quot;github.com/hyperledger/fabric-sdk-go/pkg/client/channel&quot;
 &quot;github.com/hyperledger/fabric-sdk-go/pkg/core/config&quot;
 &quot;github.com/hyperledger/fabric-sdk-go/pkg/fabsdk&quot;
)

// 配置信息
var (
 sdk           *fabsdk.FabricSDK                              // Fabric SDK
 channelName   = &quot;appchannel&quot;                                 // 通道名称
 username      = &quot;Admin&quot;                                      // 用户
 chainCodeName = &quot;fabric-realty&quot;                              // 链码名称
 endpoints     = []string{&quot;peer0.jd.com&quot;, &quot;peer0.taobao.com&quot;} // 要发送交易的节点
)

// init 初始化
func init() {
 var err error
 // 通过配置文件初始化SDK
 sdk, err = fabsdk.New(config.FromFile(&quot;config.yaml&quot;))
 if err != nil {
  panic(err)
 }
}

// ChannelExecute 区块链交互
func ChannelExecute(fcn string, args [][]byte) (channel.Response, error) {
 // 创建客户端，表明在通道的身份
 ctx := sdk.ChannelContext(channelName, fabsdk.WithUser(username))
 cli, err := channel.New(ctx)
 if err != nil {
  return channel.Response{}, err
 }
 // 对区块链账本的写操作（调用了链码的invoke）
 resp, err := cli.Execute(channel.Request{
  ChaincodeID: chainCodeName,
  Fcn:         fcn,
  Args:        args,
 }, channel.WithTargetEndpoints(endpoints...))
 if err != nil {
  return channel.Response{}, err
 }
 //返回链码执行后的结果
 return resp, nil
}

// ChannelQuery 区块链查询
func ChannelQuery(fcn string, args [][]byte) (channel.Response, error) {
 // 创建客户端，表明在通道的身份
 ctx := sdk.ChannelContext(channelName, fabsdk.WithUser(username))
 cli, err := channel.New(ctx)
 if err != nil {
  return channel.Response{}, err
 }
 // 对区块链账本查询的操作（调用了链码的invoke），只返回结果
 resp, err := cli.Query(channel.Request{
  ChaincodeID: chainCodeName,
  Fcn:         fcn,
  Args:        args,
 }, channel.WithTargetEndpoints(endpoints...))
 if err != nil {
  return channel.Response{}, err
 }
 //返回链码执行后的结果
 return resp, nil
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>在这段代码中，我们将使用 <code>Admin</code> 的身份去调用合约，并将每次的交易同时发送给 <code>peer0.jd.com</code> 和 <code>peer0.taobao.com</code> 节点进行背书，这是因为我们在实例化链码的时候指定了背书策略为 <code>AND ('TaobaoMSP.member','JDMSP.member')</code> ，代表交易需要同时得到 <code>Taobao</code>和 <code>JD</code> 组织成员的背书才允许通过。每次写入账本时，会验证这两个节点的数据一致性，只有当这两个节点的数据一致时，交易才算最终成功。</p> <p>继续编写 <code>main.go</code> ，我们使用 <code>gin</code> 来创建一个 http 服务：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>package main

import (
 &quot;bytes&quot;
 &quot;encoding/json&quot;

 &quot;github.com/gin-gonic/gin&quot;
)

func main() {
 g := gin.Default()
 g.GET(&quot;/query&quot;, func(c *gin.Context) {
  args := make([][]byte, 0)
  user := c.Query(&quot;user&quot;)
  if user != &quot;&quot; {
   args = append(args, []byte(user))
  }
  // 调用链码的query函数
  resp, err := ChannelQuery(&quot;query&quot;, args)
  if err != nil {
   c.AbortWithStatusJSON(500, gin.H{&quot;err&quot;: err.Error()})
   return
  }
  var data []map[string]interface{}
  if err = json.Unmarshal(bytes.NewBuffer(resp.Payload).Bytes(), &amp;data); err != nil {
   c.AbortWithStatusJSON(500, gin.H{&quot;err&quot;: err.Error()})
   return
  }
  c.JSON(200, data)
 })
 g.POST(&quot;/transfer&quot;, func(c *gin.Context) {
  from := c.Query(&quot;from&quot;)
  to := c.Query(&quot;to&quot;)
  money := c.Query(&quot;money&quot;)
  if from == &quot;&quot; || to == &quot;&quot; || money == &quot;&quot; {
   c.AbortWithStatusJSON(400, gin.H{&quot;err&quot;: &quot;参数不能为空&quot;})
   return
  }
  args := make([][]byte, 0)
  args = append(args, []byte(from), []byte(to), []byte(money))
  // 调用链码的transfer函数
  resp, err := ChannelExecute(&quot;transfer&quot;, args)
  if err != nil {
   c.AbortWithStatusJSON(500, gin.H{&quot;err&quot;: err.Error()})
   return
  }
  c.JSON(200, gin.H{&quot;msg&quot;: string(resp.Payload)})
 })
 g.Run(&quot;0.0.0.0:8000&quot;)
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>在 <code>main</code> 函数中，我们创建了两个接口 <code>GET /query</code> 和 <code>POST /transfer</code> ，其中 <code>/query</code> 接口调用链码的 <code>query</code> 函数功能实现查询用户余额，<code>/transfer</code> 接口调用链码的 <code>transfer</code> 函数功能实现转账功能。</p> <p>我们将继续使用 Docker 部署该应用程序，这样的好处是可以和区块链网络处于同一网络下，方便调用节点，当然你也可以更改 <code>config.yaml</code> 文件去调用暴露在宿主机的节点端口也是可以的，首先编写 <code>Dockerfile</code> 文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM golang:1.14 AS app
ENV GO111MODULE=on
ENV GOPROXY https://goproxy.cn,direct
WORKDIR /root/togettoyou
COPY . .
RUN CGO_ENABLED=0 go build -v -o &quot;app&quot; .

FROM scratch
WORKDIR /root/togettoyou/
COPY --from=app /root/togettoyou/app ./
COPY --from=app /root/togettoyou/config.yaml ./
ENTRYPOINT [&quot;./app&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>docker-compose.yml</code> 文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>version: '2.1'

networks:
  fabric_network:
    external:
      name: fabric_network

services:
  app:
    build: .
    image: app:latest
    ports:
      - &quot;8000:8000&quot;
    volumes:
      - ./../network/crypto-config:/network/crypto-config # 挂载搭建区块链网络时生成的crypto-config文件夹
    networks:
      - fabric_network
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>其中挂载的 <code>crypto-config</code> 文件夹就是之前搭建区块链网络时生成的。</p> <p>编译部署应用程序：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker-compose build
$ docker-compose up
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>调用应用程序的接口：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ curl &quot;http://localhost:8000/query&quot;
[{&quot;balance&quot;:1000,&quot;name&quot;:&quot;A&quot;},{&quot;balance&quot;:1000,&quot;name&quot;:&quot;B&quot;}]

$ curl &quot;http://localhost:8000/query?user=A&quot;
[{&quot;balance&quot;:1000,&quot;name&quot;:&quot;A&quot;}]

$ curl &quot;http://localhost:8000/query?user=B&quot;
[{&quot;balance&quot;:1000,&quot;name&quot;:&quot;B&quot;}]

$ curl -X POST &quot;http://localhost:8000/transfer?from=A&amp;to=B&amp;money=500&quot;
{&quot;msg&quot;:&quot;ok&quot;}

$ curl &quot;http://localhost:8000/query&quot;
[{&quot;balance&quot;:500,&quot;name&quot;:&quot;A&quot;},{&quot;balance&quot;:1500,&quot;name&quot;:&quot;B&quot;}]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>到这里，我们就已经完整地实现了一个区块链应用了。你也可以继续为这个区块链应用实现前端页面。流程呢，和传统前后端分离架构也没什么区别。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/study/yaml学习.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        yaml文件编写
      </a></span> <span class="next"><a href="/study/remix使用.html">
        Remix使用以及部分合约漏洞复现
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> <div class="page-anchor"><div class="ant-space ant-space-vertical" style="width:100%;"><div class="ant-space-item"><div class="page-anchor-offset"><div><div class="ant-anchor-wrapper" style="max-height:100vh;"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a href="#_0x00-to-begin-with" title="0x00 To begin with" class="ant-anchor-link-title">0x00 To begin with</a></div><div class="ant-anchor-link"><a href="#_0x01-区块链基础知识" title="0x01 区块链基础知识" class="ant-anchor-link-title">0x01 区块链基础知识</a><div class="ant-anchor-link"><a href="#区块block" title="区块block" class="ant-anchor-link-title">区块block</a></div><div class="ant-anchor-link"><a href="#区块链blockchain" title="区块链blockchain" class="ant-anchor-link-title">区块链blockchain</a></div><div class="ant-anchor-link"><a href="#类型" title="类型" class="ant-anchor-link-title">类型</a></div><div class="ant-anchor-link"><a href="#智能合约smart-contract" title="智能合约Smart contract" class="ant-anchor-link-title">智能合约Smart contract</a></div></div><div class="ant-anchor-link"><a href="#hyperledger-fabric相关知识" title="Hyperledger Fabric相关知识" class="ant-anchor-link-title">Hyperledger Fabric相关知识</a><div class="ant-anchor-link"><a href="#整体介绍" title="整体介绍" class="ant-anchor-link-title">整体介绍</a></div><div class="ant-anchor-link"><a href="#联盟" title="联盟" class="ant-anchor-link-title">联盟</a></div><div class="ant-anchor-link"><a href="#节点" title="节点" class="ant-anchor-link-title">节点</a></div><div class="ant-anchor-link"><a href="#通道" title="通道" class="ant-anchor-link-title">通道</a></div><div class="ant-anchor-link"><a href="#链码" title="链码" class="ant-anchor-link-title">链码</a></div><div class="ant-anchor-link"><a href="#搭建区块链网络" title="搭建区块链网络" class="ant-anchor-link-title">搭建区块链网络</a></div><div class="ant-anchor-link"><a href="#编写智能合约" title="编写智能合约" class="ant-anchor-link-title">编写智能合约</a></div><div class="ant-anchor-link"><a href="#部署链码" title="部署链码" class="ant-anchor-link-title">部署链码</a></div><div class="ant-anchor-link"><a href="#编写应用程序" title="编写应用程序" class="ant-anchor-link-title">编写应用程序</a></div></div></div></div></div></div></div></div></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b6aa09f0.js" defer></script><script src="/assets/js/2.be74dbea.js" defer></script><script src="/assets/js/19.96f8f9b6.js" defer></script>
  </body>
</html>